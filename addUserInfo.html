<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="css/mui.min.css" />
		<style>
			* {
				font-family: "黑体";
				color: #333333;
				font-size: 15px;
			}
			li {
				list-style: none;
			}
			hr {
				border: 0px;
			}
			form {
				margin-left: 3%;
				width: 94%;
			}
			input {
				text-align: right;
			}
			.mui-input-row:last-child{
				height: 60px;
			}
			.head {
				height: 35px;
			}
			#head {
				height: 40px;
				line-height: 50px;
			}
			#headImg{
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 35px;
				height: 35px;
			}
			#phone {
				color: #666666;
			}
			textarea {
				width: 94%;
				height: 75px;
				font-size: 15px;
				margin-left: 3%;
			}
			#nameBox, #realNameBox, #sexBox, #areaBox, #emailBox, #phone {
				height: 44px;
				line-height: 40px;
			}
			.radio_inline{
                display: inline-block;
                width: 34%;
                float: right;
            }
            .radio_inline label{
                width: 10%;
                padding-left: 30px;
                padding-right: 20px;
            }
            .radio_inline input[type=radio]{
                right: auto;
            }
            .mui-btn {
            	width: 50px;
            	height: 30px;
            	margin-top: 7px;
            	line-height: 30px;
            }
            #submit {
            	width: 50px;
            	height: 30px;
            	margin-top: 7px;
            	line-height: 30px;
            	border: solid 1px #AAAAAA;
            }
            #sex {
            	width: 10%;
            	height: 44px;
            	margin-right: 15px;
				direction: rtl;
            	font-size: 15px;
            	float: right;
            }
            #province {
            	width: 12%;
            	height: 44px;
				direction: rtl;
				font-size: 15px;
            	float: right;
            }
            #city {
            	width: 12%;
            	height: 44px;
				direction: rtl;
				font-size: 15px;
            	float: right;
            }
            #campus {
            	width: 30%;
            	height: 44px;
            	border-right: solid 2px #000000;
            	margin-right: 15px;
				direction: rtl;
				font-size: 15px;
            	float: right;
            }
            .mui-input-row label {
            	line-height: 22px;
            }
            .mui-input-row input {
            	height: 44px;
            	font-size: 16px;
            }
            textarea {
            	color: #666666;
            }
		</style>
	</head>
	<body>

		<div class="mui-navbar-inner mui-bar mui-bar-nav">
			<h1 class="mui-center mui-title">完善个人资料</h1>
			<button id="submit" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">完成</button>
		</div>
		
		<div class="mui-content">
			<hr />
			<form class="mui-input-group">
				<li class="mui-table-view-cell">
					<div id="head" class="mui-navigate-right">头像
						<span class=" head mui-pull-right">
							<img class="head-img mui-action-preview" id="headImg" src="images/logo.png"/>
						</span>
					</div>
				</li>
				<div id="nameBox" class="mui-input-row">
					<label>昵称</label>
					<input id="name" type="text" placeholder="必填">
				</div>
				<div id="realNameBox"class="mui-input-row line">
					<label>真实姓名</label>
					<input id="realName" type="text" placeholder="选填">
				</div>
				<div id="sexBox" class="mui-input-row ">
                    <label>性别</label>
                    <select id="sex">
                    	<option value="1">男</option>
                    	<option value="0">女</option>
                    </select>           
           		</div>
           		<div id="areaBox" class="mui-input-row ">
                    <label>选择学校</label>
                     <select id="campus">
                     	<option>学校</option>
                     </select>
                     <select id="city">
                     	<option>市</option>
                     </select>
                     <select id="province">
                     	<option>省</option>
                     </select>
           		</div>
				<div id="emailBox" class="mui-input-row">
					<label>邮箱地址</label>
					<input id="email" type="text" placeholder="邮箱号">
				</div>
				<div id="phoneBox" class="mui-input-row">
					<label>手机号</label>
					<input id="phone" type="text" value="18000529405" class="mui-input-clear" disabled="disabled">
				</div>
			</form>
			<div class="mui-input-row">
				<label>个人简介：</label>
			</div>
			<textarea id='personalIntroduce' class="mui-input-clear" placeholder="至少10字，限制25字">这个人很懒，什么也没留下...</textarea>
		</div>
		
		<script src="js/mui.min.js"></script>
		<script src="js/mui.view.js"></script>
		<script src="js/common.js"></script>
		<script>
			mui.init();
			var id = localStorage.getItem("id");
			var token = localStorage.getItem("token");
			var nameBox = document.getElementById("name");
			var realNameBox = document.getElementById("realName");
			var sexBox = document.getElementById("sex");
			var province = document.getElementById("province");
			var city = document.getElementById("city");
			var campus = document.getElementById("campus");
			var emial =document.getElementById("email");
			var personalIntroduceBox = document.getElementById("personalIntroduce");
			
			//获取所有省份
			mui.ajax(baseUrl + "/user/getArea", {
				data : {
					"id" : id,
					"areaId" : 1
				},
				headers : {
					"authorization" : token
				},
				type: 'post',
				dataType: 'json',
				success: function(data) {
					province.options.length=0;
					mui.each(data.data, function(index, item) {
						province.add(new Option(item.areaName, item.areaId));
					});
					var provinceId =province.options[province.selectedIndex].value;
					getCityAndCampus(provinceId);
				},
				error: function() {
					mui.toast("未知错误");
				}
			});
			
			//省市联动
			province.addEventListener('change', function() {
				var areaId = province.options[province.selectedIndex].value;
				getCityAndCampus(areaId);
			});
			
			//市学校联动
			city.addEventListener('change', function() {
				var areaId = city.options[city.selectedIndex].value;
				getCampus(areaId);
			});
			
			//通过省id获取市列表和第一个市的学校列表
			var getCityAndCampus = function(areaId) {
				mui.ajax(baseUrl + "/user/getArea", {
					data : {
						"id" : id,
						"areaId" : areaId
					},
					headers : {
						"authorization" : token
					},
					type: 'post',
					dataType: 'json',
					success: function(data) {
						city.options.length=0;
						mui.each(data.data, function(index, item) {
							city.add(new Option(item.areaName, item.areaId));
						});
						var cityId = city.options[city.selectedIndex].value;
						getCampus(cityId);
					},
					error: function() {
						mui.toast("未知错误");
					}
				});
			}
			
			//通过市id获取学校列表
			var getCampus = function(areaId) {
				mui.ajax(baseUrl + "/user/getCampus", {
					data : {
						"id" : id,
						"areaId" : areaId
					},
					headers : {
						"authorization" : token
					},
					type: 'post',
					dataType: 'json',
					success: function(data) {
						campus.options.length=0;
						mui.each(data.data, function(index, item) {
							campus.add(new Option(item.campusName, item.campusId));
						});
					},
					error: function() {
						mui.toast("error");
					}
				});
			}
			
			//验证邮箱哥格式
			email.addEventListener('blur', function() {
				if (emial.value != "" && !checkEmail(email.value)) {
					mui.toast("邮箱格式错误");
				}
			});
			
			var checkEmail = function(email) {
				var reg = /^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/
				return email.match(reg);
			}
			
			var submitBtn = document.getElementById("submit");
			submitBtn.addEventListener('tap', function() {
				if (nameBox.value == "" || nameBox.value.length > 8) {
					mui.toast("昵称不能为空");
					return;
				}
				if (realNameBox.value != "" && realNameBox.value.length > 4) {
					mui.toast("名字过长");
					return;
				}
				if (campus.value == null || campus.value == "") {
					mui.toast("请选择学校");
					return;
				}
				if (email.value != "" && !checkEmail(email.value)) {
					mui.toast("邮箱格式错误");
					return;
				}
				if (personalIntroduceBox.value.length < 10 || personalIntroduceBox.value.length > 25) {
					mui.toast("个人介绍10-25字");
				}
				
				mui.ajax(baseUrl + "/user/addUser",{
					headers : {
						"authorization" : token
					},
					data: {
						'id': id,
						'nickname': nameBox.value,
						'realname': realName.value,
						'sex': sexBox.value,
						'email': email.value,
						'areaId': city.value,
						'campusId': campus.value,
						'mobile': phone.value,
						'introduce' : personalIntroduceBox.value
					},
					dataType: 'json',
					success: function(data) {
						mui.openWindow({
							id: 'index-menu',
							url: 'index-menu.html'
						});
					},
					error: function() {
						mui.toast("网络错误");
					}
				});
			});
		</script>
	</body>
</html>
