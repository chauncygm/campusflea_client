<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<style>
			#mobile {
				float: left;
				width: 48%;
			}
			#send {
				float: left;
				width: 28%;
			}
			#blank {
				margin-top: 10px;
				height: 10px;
			}
			.mui-input-group label {
				width: 23%;
			}
			.mui-input-right {
				width: 10%;
			}
			.mui-input-row {
				margin-top: 10px;
			}
			.mui-input-row label~input,
			.mui-input-row label~select,
			.mui-input-row label~textarea {
				width: 71%;
				float: left;
			}
			.validate {
				width: 7%;
				float: right;
			}
			.mui-content-padded {
				margin-top: 25px;
			}
			.mui-btn {
				padding: 10px;
			}
			.disable {
				background: #808080;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">注册</h1>
		</header>
		<div class="mui-content">
			<form class="mui-input-group">
				<div id= "blank"></div>
				<div class="mui-input-row">
					<label>用户名</label>
					<input id='username' type="text" maxlength="12" class="mui-input-clear mui-input validate" placeholder="4-10位,可包含英文,数字,下划线"/>
					<div id='checkuser'></div>	
				</div>
				<div class="mui-input-row">
					<label>密码</label>
					<input id='password' type="password" maxlength="14" class="mui-input-clear mui-input validate" placeholder="6-14位,必须以字母开头"/>
					<div id='checkpass'></div>
				</div>
				<div class="mui-input-row">
					<label>确认</label>
					<input id='password_confirm' type="password" maxlength="14" class="mui-input-clear mui-input validate" placeholder="请确认密码"/>
					<div id='recheckpass'></div>
				</div>
				<div class="mui-input-row">
					<label>手机号</label>
					<input id='mobile' type="text" maxlength="11" class="mui-input" placeholder="请输入手机号">
					<button id='send' class="mui-btn mui-btn-primary">获取验证码</button>
				</div>
				
				<div class="mui-input-row">
					<label>验证码</label>
					<input id='captchaCode' type="text" class="mui-input-clear mui-input" placeholder="请输入验证码">
				</div>
			</form>
			<div class="mui-content-padded">
				<button id='reg' class="mui-btn mui-btn-block mui-btn-primary">注册</button>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js"></script>
		<script src='js/common.js'></script>
		<script>
			(function($, doc) {
				$.init();
				var usernameBox = doc.getElementById('username');
				var passwordBox = doc.getElementById('password');
				var passwordConfirmBox = doc.getElementById('password_confirm');
				var mobileBox = doc.getElementById("mobile");
				var captchaCodeBox = doc.getElementById("captchaCode");
				var sendBtn = doc.getElementById("send");
				var regButton = doc.getElementById('reg');
				var validateBox = doc.getElementsByClassName("validate");
				for (var i = 0; i < validateBox.length; i++) {
					validateBox[i].addEventListener('focus', function() {
						//焦点状态取消验证结果
						this.nextElementSibling.nextElementSibling.innerHTML = "";
					});
				}
				
				//参数验证，绑定事件
				usernameBox.addEventListener("blur", function() {
					ajaxCheckUserName();
				});
				passwordBox.addEventListener("blur", function() {
					checkPassword();
				});
				passwordConfirmBox.addEventListener("blur", function() {
					confimPassword();
				});
				//发送验证码按钮监听
				sendBtn.addEventListener("tap", function(){
					sendCaptchaCode();
				});
				//注册按钮监听
				regButton.addEventListener('tap', function(event) {
					ajaxRegister();
				});
				
				//验证用户名格式，是否被注册
				var ajaxCheckUserName = function(){
					var reg = /^[_a-zA-Z0-9]{4,10}$/;
					if (!reg.test(usernameBox.value)) {
						mui.toast("用户名格式错误");
						doc.getElementById("checkuser").innerHTML = "<span class='mui-icon mui-icon-closeempty' style='color:red'></span>";
						return;
					}
					var url = baseUrl + "/user/checkUserName"
					mui.ajax(url, {
						data : {
							'username' : usernameBox.value,
						},
						type : 'POST',
						dataType : 'json',
						success : function(data) {
							console.log(data);
							if (data.code == 100) {
								doc.getElementById("checkuser").innerHTML = "<span class='mui-icon mui-icon-checkmarkempty' style='color:green'></span>";
							} else {
								doc.getElementById("checkuser").innerHTML = "<span class='mui-icon mui-icon-checkmarkempty' style='color:green'></span>";
							}
							if (data.code == 301) {
								mui.toast("用户名已被注册");
							}
							if (data.code == 400) {
								mui.toast("用户名格式错误");
							}
						},
						error : function(xhr, type, errorThrown) {
							mui.toast("未知错误");
						}
					});
				}
				
				//验证密码格式
				var checkPassword = function(){
					var reg =/^[a-zA-Z]\w{5,13}$/;
					if (passwordBox.value.match(reg)) {
						doc.getElementById("checkpass").innerHTML = "<span class='mui-icon mui-icon-checkmarkempty' style='color:green'></span>";
					} else {
						mui.toast("密码格式错误");
						doc.getElementById("checkpass").innerHTML = "<span class='mui-icon mui-icon-closeempty' style='color:red'></span>";
					}
				}
				
				//确认密码
				var confimPassword = function(){
					if (passwordBox.value == "" || passwordConfirmBox.value == "") {
						return;
					}
					if (passwordBox.value == passwordConfirmBox.value) {
						doc.getElementById("recheckpass").innerHTML = "<span class='mui-icon mui-icon-checkmarkempty' style='color:green'></span>";
					} else {
						mui.toast("密码不一致")
						doc.getElementById("recheckpass").innerHTML = "<span class='mui-icon mui-icon-closeempty' style='color:red'></span>";
					}
				}
				
				//验证码冷却60s处理
				var sendBtnCD = function() {
					sendBtn.setAttribute("disabled", true);
					sendBtn.classList.add("disable");
					var times = 60;
					
					var x = setInterval(function() {
						sendBtn.innerHTML = "重新发送(" + times + "s)";
						times--;
						if (times == 0) {
							times = 60;
							sendBtn.removeAttribute("disabled");
							sendBtn.classList.remove("disable");
							sendBtn.innerHTML = "获取验证码";
							clearInterval(x);
						}
					}, 1000);
				}
				
				//发送验证码
				var sendCaptchaCode = function() {
					//验证手机号
					var reg = /^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8}$/;
					if (!mobileBox.value.match(reg)) {
						mui.toast("请输入正确的手机号");
						return;
					}
					console.log('111');
					var url = baseUrl + "/user/sendCaptchaCode";
					$.ajax(url, {
						data : {
							'mobile' : mobileBox.value,
							'type' : '_regist'
						},
						dataType : 'json',
						type : 'POST',
						success : function(data) {
							console.log("success");
							sendBtnCD();
							if (data.code == 200) {
								mui.toast("已发送");
							} else {
								mui.toast("发送异常")
							}
						},
						error : function(xhr, type, errorThrown) {
							mui.toast("未知错误");
						}
					});
				}
				
				var checkParam = function() {
					if (usernameBox.value == "") {
						mui.toast("请输入用户名");
						return false;
					}
					if (passwordBox.value == "") {
						mui.toast("请输入密码");
						return false;
					}
					if (passwordConfirmBox.value == "") {
						mui.toast("请确认密码");
						return false;
					}
					if (mobileBox.value== "") {
						mui.toast("请输入手机号");
						return false;
					}
					if (captchaCodeBox.value == "") {
						mui.toast("请输入验证码");
						return false;
					}
					return true;
				}
				
				//注册
				var ajaxRegister = function() {
					if (!checkParam()){
						return;
					}
					var url = baseUrl + "/user/register";
					$.ajax(url, {
						data : {
							'username' : usernameBox.value,
							'password' : passwordBox.value,
							'mobile' : mobileBox.value,
							'captchaCode' : captchaCodeBox.value
						},
						type : 'POST',
						dataType : 'json',
						success : function(data) {
							if(data.code == 301) {
								mui.toast("用户名已被使用");
							}
							if (data.code == 303) {
								mui.toast("验证码错误");
							}
							if (data.code == 304) {
								mui.toast("验证码已失效");
							}
							if (data.code == 200) {
								mui.toast("注册成功");
							} 
							if (data.code == 201) {
								mui.toast("验证失败");
							}
						},
						error : function(xhr, type, errorThrown) {
							mui.toast("未知错误");
						}
					});
				}
			}(mui, document));
		</script>
	</body>

</html>